name: Deploy

on:
  workflow_run:
    workflows: ["Core Check"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 创建 deployment
      - name: Create GitHub Deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.workflow_run.head_sha,
              environment: "production",
              required_contexts: [],
            });
            return String(deployment.data.id);

      # 触发 Dokploy 部署
      - name: Trigger Dokploy Deployment
        id: dokploy
        run: |
          curl -X "POST" \
            "https://app.jianyuelab.org/api/application.deploy" \
            -H "accept: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{ "applicationId": "${{ secrets.APPLICATION_ID }}" }'

      # 更新部署状态为成功
      - name: Update Deployment Status
        if: success()
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ steps.deployment.outputs.result }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number(process.env.DEPLOYMENT_ID),
              state: "success",
              environment_url: "https://maps.postal.wiki",
            });

      # 部署失败时更新状态
      - name: Update Deployment Status (Failed)
        if: failure()
        uses: actions/github-script@v7
        env:
          DEPLOYMENT_ID: ${{ steps.deployment.outputs.result }}
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: Number(process.env.DEPLOYMENT_ID),
              state: "failure",
            });
