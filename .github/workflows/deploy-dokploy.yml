name: Deploy

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 创建 deployment
      - name: Create GitHub Deployment
        id: deployment
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: "production",
              required_contexts: [],
            });
            console.log(deployment.data.id);
            return deployment.data.id;

      # 触发 Dokploy 部署
      - name: Trigger Dokploy Deployment
        id: dokploy
        run: |
          curl -X "POST" \
            "https://app.jianyuelab.org/api/application.deploy" \
            -H "accept: application/json" \
            -H "x-api-key: ${{ secrets.DOKPLOY_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{ "applicationId": "${{ secrets.APPLICATION_ID }}" }'

      # 更新部署状态为成功
      - name: Update Deployment Status
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: "success",
              environment_url: "https://maps.postal.wiki",
            });

      # 部署失败时更新状态
      - name: Update Deployment Status (Failed)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.deployment.outputs.result }},
              state: "failure",
            });
